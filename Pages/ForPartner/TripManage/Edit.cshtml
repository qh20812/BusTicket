@page "{id:int?}"
@model BusTicketSystem.Pages.ForPartner.TripManage.EditModel
@{
    Layout = "_PartnerLayout"; // Assuming a _PartnerLayout
    // ViewData["Title"] is set in OnGetAsync
}

<div class="header">
    <div class="left">
        <h1>@ViewData["Title"]</h1>
        <ul class="breadcrumb">
            <li><a asp-page="/ForPartner/Dashboard/Index">Tổng quan</a></li>/
            <li><a asp-page="./Index">Chuyến đi</a></li>/
            <li><a class="active">@(Model.TripInput.TripId == 0 ? "Đề xuất mới" : "Chỉnh sửa")</a></li>
        </ul>
    </div>
</div>

<div class="bottom-data">
    <div class="orders">
        <div class="header">
            <i class='bi bi-pencil-square bx'></i>
            <h3>@(Model.TripInput.TripId == 0 ? "Thông tin Chuyến đi mới (Đề xuất)" : $"Chỉnh sửa Chuyến đi ID: {Model.TripInput.TripId}")</h3>
        </div>

        <form method="post" class="p-3">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
            <input type="hidden" asp-for="TripInput.TripId" />
            @* CompanyId is set automatically for partners, no input needed *@

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="TripInput.RouteId" class="form-label"></label>
                    <select asp-for="TripInput.RouteId" asp-items="Model.Routes" class="form-select">
                        <option value="">-- Chọn lộ trình (đã duyệt) --</option>
                    </select>
                    <span asp-validation-for="TripInput.RouteId" class="text-danger"></span>
                    <small><a asp-page="/ForPartner/RouteManage/Index" target="_blank">Đề xuất hoặc Quản lý lộ trình</a></small>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="TripInput.BusId" class="form-label"></label>
                    <select asp-for="TripInput.BusId" asp-items="Model.Buses" class="form-select">
                        <option value="">-- Chọn xe --</option>
                    </select>
                    <span asp-validation-for="TripInput.BusId" class="text-danger"></span>
                    @* Link to partner's bus management if it exists *@
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="TripInput.DriverId" class="form-label"></label>
                    <select asp-for="TripInput.DriverId" asp-items="Model.Drivers" class="form-select">
                        <option value="">-- Chọn tài xế --</option>
                    </select>
                    <span asp-validation-for="TripInput.DriverId" class="text-danger"></span>
                </div>
                 <div class="col-md-6 mb-3">
                    <label asp-for="TripInput.DepartureTime" class="form-label"></label>
                    <input asp-for="TripInput.DepartureTime" class="form-control" type="datetime-local" />
                    <span asp-validation-for="TripInput.DepartureTime" class="text-danger"></span>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="TripInput.Price" class="form-label"></label>
                    <input asp-for="TripInput.Price" class="form-control" type="number" step="1000" />
                    <span asp-validation-for="TripInput.Price" class="text-danger"></span>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="TripInput.InitialAvailableSeats" class="form-label"></label>
                    <input asp-for="TripInput.InitialAvailableSeats" class="form-control" type="number" readonly title="Số ghế sẽ được lấy tự động từ thông tin xe"/>
                    <small class="form-text text-muted">Số ghế sẽ được lấy tự động từ thông tin xe đã chọn.</small>
                    <span asp-validation-for="TripInput.InitialAvailableSeats" class="text-danger"></span>
                </div>
            </div>
            
            @if (Model.TripInput.TripId != 0) // Show status if editing
            {
                <div class="alert alert-info">
                    Trạng thái hiện tại: <strong>@Html.DisplayFor(model => model.TripInput.Status)</strong>
                    @if(Model.TripInput.Status == BusTicketSystem.Models.TripStatus.Rejected && !string.IsNullOrEmpty(Model.TripInput.CancellationReason))
                    {
                        <br/><em>Lý do từ chối: @Model.TripInput.CancellationReason</em>
                    }
                </div>
                 <input type="hidden" asp-for="TripInput.Status" />
            }


            <h4>Điểm dừng chân</h4>
            <div id="tripStopsContainer">
                 @if(Model.TripInput.TripStops!=null){
                    for(int i=0;i<Model.TripInput.TripStops.Count;i++){
                        <partial name="_TripStopInputPartial" model="Model.TripInput.TripStops[i]" view-data='new ViewDataDictionary(ViewData){{"Index",i}}'/>
                    }
                }
            </div>
            <button type="button" id="addTripStopBtn" class="btn btn-outline-secondary btn-sm mt-2"><i class="bi bi-plus-circle me-1"></i>Thêm điểm dừng</button>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary">@(Model.TripInput.TripId == 0 ? "Gửi đề xuất" : "Cập nhật & Gửi lại đề xuất")</button>
                <a asp-page="./Index" class="btn btn-secondary">Hủy</a>
            </div>
        </form>
    </div>
</div>

<div id="tripStopTemplateContainer" style="display: none;">
    <script id="tripStopTemplate" type="text/html">
        @* Copy the template from admin's Edit.cshtml or your _TripStopInputPartial.cshtml content *@
        <div class="row g-3 mb-3 trip-stop-item border rounded p-3 bg-light" data-index="{index}">
            <input type="hidden" name="TripInput.TripStops[{index}].StopId" value="{stopId}" />
            <div class="col-md-2">
                <label class="form-label">Thứ tự</label>
                <input type="number" name="TripInput.TripStops[{index}].StopOrder" value="{stopOrder}" class="form-control form-control-sm" required min="1" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Tên trạm</label>
                <input type="text" name="TripInput.TripStops[{index}].StationName" value="{stationName}" class="form-control form-control-sm" required maxlength="255" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Vĩ độ</label>
                <input type="number" step="any" name="TripInput.TripStops[{index}].Latitude" value="{latitude}" class="form-control form-control-sm" required />
            </div>
            <div class="col-md-3">
                <label class="form-label">Kinh độ</label>
                <input type="number" step="any" name="TripInput.TripStops[{index}].Longitude" value="{longitude}" class="form-control form-control-sm" required />
            </div>
            <div class="col-md-1 d-flex align-items-end">
                 <button type="button" class="btn btn-danger btn-sm remove-trip-stop-btn w-100"><i class="bi bi-x-circle"></i> Xóa</button>
            </div>
        </div>
    </script>
</div>


@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const container = document.getElementById('tripStopsContainer');
            const addButton = document.getElementById('addTripStopBtn');
            const template = document.getElementById('tripStopTemplate').innerHTML;
            let index = container.querySelectorAll('.trip-stop-item').length;
        });
    </script>
}